---
title: "Gender bias in audience of seminars and career position"
author: "Melina Leite, Júlia Barreto & Isabella Romitelli"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
  pdf_document:
    highlight: tango
    toc: yes
---
```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
library(tidyverse); library(cowplot); library(patchwork)
theme_set(theme_cowplot())
library(janitor); library(lubridate)
library(DHARMa); library(ggeffects)
library(bbmle); library(MASS)
library(hnp); library(performance)
library(FactoMineR); library(factoextra)


opts_chunk$set(fig.align = 'center', warning = FALSE, message = FALSE, error = FALSE, echo=T, cache=F)
options(formatR.arrow = TRUE, width = 90, help_type = "html")
```

# Data

## EcoEncontros Seminar talks


Talks from EcoEncontros Seminar series at the Graduate Program of Ecology in the University of São Paulo (PPGE-USP), Brazil

See file `metadata.txt`, in folder `data` for more description and detail of the dataset.
```{r}
data <- read.table("data/presentations_PPGE_2008-2019.csv", sep=",",
                   header=T, as.is=T)
data$date <- dmy(data$date)
data$year <- year(data$date) 
#skimr::skim(data)
```

Excluding special events as round tables and discussions not related to a project or study presented by someone.

```{r}
IDs <- c(154, 250, 211, 289)
data <- data %>% filter(!id %in% IDs)
```

For this specific analysis, excluding speakers that are not in academia ("others"), and keeping undergraduate students, MD and PhD in the group student. postdoc, professor or researcher*.

*Researchers are included in the professor categorical position (column `position_cat`) because all of them come from research institutions.

```{r}
data <- data %>% filter(position_cat != "others")
data$position_cat <- fct_relevel(data$position_cat, "student", 
                                 "postdoc","professor")
```

Excluding seminars with more than one speaker

```{r}
events <- data %>% count(id) %>% filter(n>1)
data <- data %>% filter(!id %in% events$id,
                        !is.na(audience_n))
```


```{r}
dim(data)
```

# Data description

Regarding the differences in the audience, there were `r length(data$audience_female!=NA)` talks with the number of attendees, allowing us to conduct the analysis, as we excluded seminars with more than one presenter (round tables, and special seminars).

Audience by gender and academic position

```{r}
ggplot(data, aes(x=position_cat, y=audience_n, fill=gender)) +
  scale_fill_manual(values = c("#b2abd2", "#fdb863"))+
  geom_boxplot()
  #geom_violin(position = position_dodge(0.8)) +
  #geom_jitter(position=position_jitterdodge(0.2),shape=21)
```

```{r}
library(ggbeeswarm)
# outra opção
ggplot(data, aes(x=position_cat, y=audience_n, fill=gender)) +
  scale_fill_manual(values = c("#b2abd2", "#fdb863"))+
  scale_color_manual(values = c("#b2abd2", "#fdb863"))+
  geom_violin(col="black") +
  geom_quasirandom(dodge.width = 0.9, shape=21)+
  stat_summary(fun.y=median, aes(ymin=..y.., ymax=..y..),geom='errorbar', 
               width=0.8, size=0.8, position = position_dodge(width = 0.9))+
  xlab("") + ylab("Audience (N)")
```

Variation in time
```{r, fig.height=10}
ggplot(data, aes(x=date, y=audience_n, fill=gender)) +
  facet_wrap(~position_cat, ncol=1)+
  scale_fill_manual(values = c("#b2abd2", "#fdb863"))+
  scale_color_manual(values = c("#b2abd2", "#fdb863"))+
  geom_quasirandom(dodge.width = 0.9, shape=21)+
  geom_smooth()+
  xlab("") + ylab("Audience (N)")
```




Looking for possible biases for speakers from inside and outside PPGE. 

```{r}
data$ppge <- ifelse(data$origin == "IB", "inside", "outside")
table(data$gender,data$ppge)
```

```{r}
ggplot(data, aes(x=ppge, y=audience_n, fill=gender)) +
  scale_fill_manual(values = c("#b2abd2", "#fdb863"))+
  scale_color_manual(values = c("#b2abd2", "#fdb863"))+
  geom_violin(col="black") +
  geom_quasirandom(dodge.width = 0.9, shape=21)+
  stat_summary(fun.y=median, aes(ymin=..y.., ymax=..y..),geom='errorbar', 
               width=0.8, size=0.8, position = position_dodge(width = 0.9))+
  xlab("PPGE") + ylab("Audience (N)")
```

Looking for possible biases for speakers from Brazil and abroad. 

```{r}
data$brazilian <- ifelse(data$country == "Brasil", "yes", "no")
table(data$gender,data$brazilian)
```

```{r}
ggplot(data, aes(x=brazilian, y=audience_n, fill=gender)) +
  scale_fill_manual(values = c("#b2abd2", "#fdb863"))+
  scale_color_manual(values = c("#b2abd2", "#fdb863"))+
  geom_violin(col="black") +
  geom_quasirandom(dodge.width = 0.9, shape=21)+
  stat_summary(fun.y=median, aes(ymin=..y.., ymax=..y..),geom='errorbar', 
               width=0.8, size=0.8, position = position_dodge(width = 0.9))+
  xlab("Brazilian") + ylab("Audience (N)")
```


# Modeling


Negative binomial

```{r}
data$affirm_action <- ifelse(data$year<2018,"before", "after")
data$affirm_action <- fct_relevel(data$affirm_action, "before", "after")
```

```{r echo=TRUE}
mg0 <- glm.nb(audience_n~ 1, data=data)
mg1 <- glm.nb(audience_n~ gender, data=data)
mg2 <- glm.nb(audience_n~ position_cat, data=data)
mg3 <- glm.nb(audience_n~ year, data=data)
mg3b <- glm.nb(audience_n~ affirm_action, data=data)

mg4 <- glm.nb(audience_n~ gender + position_cat, data=data)
mg5 <- glm.nb(audience_n~ gender + year, data=data)
mg5b <- glm.nb(audience_n~ gender + affirm_action, data=data)
mg6 <- glm.nb(audience_n~ year + position_cat, data=data)
mg6b <- glm.nb(audience_n~ affirm_action + position_cat, data=data)

mg7 <- glm.nb(audience_n~ gender*position_cat, data=data)
mg8 <- glm.nb(audience_n~ gender*year, data=data)
mg8b <- glm.nb(audience_n~ gender*affirm_action, data=data)
mg9 <- glm.nb(audience_n~ year*position_cat, data=data)
mg9b <- glm.nb(audience_n~ affirm_action*position_cat, data=data)

mg10 <- glm.nb(audience_n~ gender + position_cat + year, data=data)
mg10b <- glm.nb(audience_n~ gender + position_cat + affirm_action, data=data)
mg11 <- glm.nb(audience_n~ gender*position_cat + year, data=data)
mg11b <- glm.nb(audience_n~ gender*position_cat + affirm_action, data=data)
mg12 <- glm.nb(audience_n~ gender + position_cat * year, data=data)
mg12b <- glm.nb(audience_n~ gender + position_cat * affirm_action, data=data)
mg13 <- glm.nb(audience_n~ gender*year + position_cat, data=data)
mg13b <- glm.nb(audience_n~ gender*affirm_action + position_cat, data=data)


mg14 <- glm.nb(audience_n~ gender*position_cat*year, data=data)
mg14b <- glm.nb(audience_n~ gender*position_cat*affirm_action, data=data)

AICtab(mg2, mg0,mg1, mg3, mg4,mg5,mg6,mg7,mg8,mg9,mg10,mg11,mg12,mg13,mg14,
      mg3b,mg5b,mg6b,mg8b,mg9b,mg10b,mg11b,mg12b,mg13b, mg14b,
      base=T, weights=T) %>% kable(digits=2)
```


## Residual diagnostic

```{r}
hnp::hnp(mg11b)
plot(simulateResiduals(mg11b))
```

```{r}
hnp::hnp(mg10b)
plot(simulateResiduals(mg10b))
```

## Models result

The two equally plausible models for the audience included gender, academic position and affirmative actions as predictors, with the difference that the best fitted model includes an interaction of gender and academic position (R2 = `r round(performance::r2(mg11b)$R2_Nagelkerke,2)`)

```{r echo=TRUE}
summary(mg11b)
performance::r2(mg11b)
```

Average audience before affirmative actions:`r exp(coef(mg11b)[1])`

Average audience aftter affirmative actions: `r exp(coef(mg11b)[1]+ coef(mg11b)[5])`


```{r}
myg11b <- ggpredict(mg11b, terms=c("position_cat","gender", "affirm_action"))
as.data.frame(myg11b)%>% mutate(predicted = round(predicted,digits=0))
```


Complete figure
```{r}
prs <- as.data.frame(myg11b) %>% rename(affirm_action = facet)
colnames(prs)[1] <- "position_cat"
kable(prs , digits = 0)
```


```{r}
ggplot(data, aes(x=position_cat, y=audience_n)) +
  geom_point(aes(col=gender), position = position_dodge(0.6), alpha=0.3,
             size=3,show.legend = F) +
  facet_grid(~affirm_action, 
             labeller = as_labeller(c("before"="Before affirmative actions" , "after"="After affirmative actions" ))) +
 #scale_color_manual(values = c("#b2abd2", "#fdb863")) +
  scale_color_manual(values = c("#6D57CF","#FCA532")) +
  scale_fill_manual(name="Gender", values = c("#6D57CF","#FCA532")) +
  geom_pointrange(data=prs, aes(x=position_cat, y=predicted,fill=group,
                                ymax=conf.high, ymin=conf.low), alpha=1,
             position=position_dodge(0.6), size=1, shape=21, col="black") +
  xlab("Academic position") + ylab("Audience (N)") 

ggsave("figures/audience_speakers.jpeg", width=8, height = 4)  
```


```{r}
ggplot(data, aes(x=affirm_action, y=audience_n)) +
  geom_point(aes(col=gender), position = position_dodge(0.6), alpha=0.3,
             size=3,show.legend = F) +
  facet_grid(~position_cat, labeller = 
               as_labeller(c(student = "Pós-graduande",
                             postdoc =  "Pós-doc",
                             professor = "Docente"))) +
  scale_color_manual(values = c("#6D57CF","#FCA532")) +
  scale_x_discrete(labels = c("Antes", "Depois"))+
  scale_fill_manual(name="Gênero", values = c("#6D57CF","#FCA532")) +
  geom_pointrange(data=prs, aes(x=affirm_action, y=predicted,fill=group,
                                ymax=conf.high, ymin=conf.low), alpha=1,
             position=position_dodge(0.6), size=1.2, shape=21, col="black") +
    xlab("Ações afirmativas") + ylab("Audiência (N)") 


ggsave("figures/audience_speakers_b_port.jpeg", width=8, height = 4)  
```


figura apresentacao IB-mulheres
```{r}
ggplot(data=prs, aes(x=position_cat, y=predicted,fill=group,
                                ymax=conf.high, ymin=conf.low)) +
  geom_pointrange(, alpha=1,
             position=position_dodge(0.6), size=1.2, shape=21, col="black") +
  facet_grid(~affirm_action, labeller= as_labeller(c(before = "Antes",
                                                   after = "Depois"))) +
  scale_color_manual(values = c("#6D57CF","#FCA532")) +
  scale_x_discrete(labels =  c("Pós-graduande", "Pós-doc", "Docente"))+
  scale_fill_manual(name="Gênero", values = c("#6D57CF","#FCA532")) +
    xlab("") + ylab("Audiência (N)") 

ggsave("figures/audience_speakers_C_port.jpeg", width=8, height = 4)  
```

```{r}
prs %>% filter(position_cat == "professor", affirm_action == "after") %>%
ggplot(aes(x=position_cat, y=predicted,fill=group,
                                ymax=conf.high, ymin=conf.low)) +
  geom_pointrange(alpha=1,
             position=position_dodge(0.6), size=1.2, shape=21, col="black") +
  scale_color_manual(values = c("#6D57CF","#FCA532")) +
  scale_x_discrete(labels =  c("Docente"))+
  scale_fill_manual(name="Gênero", values = c("#6D57CF","#FCA532")) +
    xlab("") + ylab("Audiência (N)") 

ggsave("figures/audience_speakers_D_port.jpeg", width=4, height = 4)  
```


```{r echo=TRUE}
summary(mg10b)
performance::r2(mg10b)
```
```{r}
myg10b <- ggpredict(mg10b, terms=c("position_cat","gender", "affirm_action"))
plot(myg10b) +
  scale_color_manual(values = c("#b2abd2", "#fdb863"))
```




# Only professors - productivity metrics

Investigating if differences in productivity between male and female professors and researches are related to the audience.

Measured productivity publication metrics from Google Scholar for professors and researchers. 

Creating productivity index using PCA 1st axis from metrics.

## PCA productivity metrics

```{r}
dp <- data %>% filter(!is.na(data$total_citation_n),
                      !is.na(data$nature_index_count))
table(dp$gender, dp$affirm_action)
```

Productivity publication metrics

```{r}
pca1 <- PCA(dp[, c(22:29)], graph=F)
p1 <- fviz_pca_biplot(pca1, col.ind = dp$gender, addEllipses=TRUE,
                      col.ind.sub="none",  geom="point",
                      repel = TRUE) +
  geom_vline(xintercept = 0, linetype="dashed") + 
  geom_hline(yintercept = 0, linetype="dashed")+
  scale_color_manual(name="Gênero",values = c("#6D57CF","#FCA532"))+
  scale_shape(name="Gênero")+
  scale_fill_manual(name="Gênero",values = c("#6D57CF","#FCA532"))+
  ggtitle("Métricas desempenho professores") +
  xlab("PC1 (52%)") + ylab("PC2 (21%)") +
  theme_cowplot()

p1
ggsave("figures/pca_biplot.jpeg", width=6, height = 6)  
```
For the analysis specific for professor talks (N=`r length(dp$id)`), the PCA results show that all the productivity metrics for professors were highly correlated (Figure 2B) with the first axis (52%of variance explained) while the institution indexes composed the second PCA axis (21% of variation explained).

Extracting PCA 2 first axes
```{r}
dp$pc1 <- pca1$ind$coord[,1]
dp$pc2 <- pca1$ind$coord[,2]
```

# Modeling

We used generalized linear models with negative binomial distribution, given the large variation in the audience (range between `r paste0(range(data$audience_n)[1], " and ", range(data$audience_n)[2])`).

**OBS interna (apagar depois)**: podem perguntar porque a gente nao colocou o affirm_action no modelo já que é importane para prever a audni6encia (como vimos no modelo anterior), eu até fiz uns testes, mas eu nao acho que devamos complicar este modelo, já que o foco aqui é comaprar professores quanto à produtividade, com hipótese clara de que dada uma mesma produtivdade ainda assim o mulheres vão ter menor audiencia que homens. Então é bom deixar isso claro no texto - de que estamos nessa análise focando apenas em genero e métrica de produtividade e por isso nao tem tempo nesses modelos.Eu também preferi colocar pc1 e pc2 sempre juntos como variável de produtividade - sem fazer modelos separados

```{r}
m0 <- glm.nb(audience_n ~ 1, data=dp)
m1 <- glm.nb(audience_n ~ gender, data=dp)
m2 <- glm.nb(audience_n ~ pc1 + pc2, data=dp)

m3 <- glm.nb(audience_n ~ gender + pc1 + pc2, data=dp)

m4 <- glm.nb(audience_n ~ gender*pc1 + gender*pc2, data=dp)

AICtab(m0,m1,m2,m3,m4,
       base=T, weights=T) %>% kable(digits=2)
```

## Residual diagnostic

Best model
```{r}
hnp(m3)
plot(simulateResiduals(m3))
```

## Model results

```{r echo=TRUE}
summary(m3)
performance::r2(m3)
```
We used the first and second PCA axis as predictors together with gender to explain the professor's audience, and found that, as expected, audience increases with productivity index (first PCA axis) but female professors still presented average audience *1.3* times smaller than male professors (R2 of the best fitting model = `r performance::r2(m3)`).


```{r}
my3 <- ggpredict(m3, terms=c("pc1","gender"))
my3 <- as.data.frame(my3)
ggplot(my3, aes(x=x, y=predicted, col=group)) +
  geom_ribbon(aes(ymin=conf.low,ymax=conf.high, fill=group), alpha=0.3,
             colour = NA) +
    geom_line()+
  scale_color_manual(name="Gender",values = c("#6D57CF","#FCA532"))+
  scale_fill_manual(name="Gender",values = c("#6D57CF","#FCA532"))+
   theme_cowplot() + ggtitle("") +
  ylab("Audience (N)") + xlab("Productivity index (PC1 axis)")+
  geom_point(data=dp, aes(x=pc1, y=audience_n, col=gender), alpha=0.6)
ggsave("figures/audience_professor.jpeg", width=9, height = 6)  
```


PC 2 - nao importante, nao "significativo"":

```{r}
my3 <- ggpredict(m3, terms=c("pc2","gender"))
plot(my3) +
  scale_color_manual(values = c("#b2abd2", "#fdb863"))+
  scale_fill_manual(values = c("#b2abd2", "#fdb863"))+
   theme_cowplot()
```


# Figure audience

```{r}
prs <- as.data.frame(myg11b) %>% rename(affirm_action = facet,
                                        position_cat=x)
f1<- ggplot(data, aes(x=affirm_action, y=audience_n)) +
  geom_point(aes(col=gender), position = position_dodge(0.6), alpha=0.3,
             size=3,show.legend = F) +
  facet_grid(~position_cat) +
 #scale_color_manual(values = c("#b2abd2", "#fdb863")) +
  scale_color_manual(values = c("#6D57CF","#FCA532")) +
  scale_fill_manual(name="Gender", values = c("#6D57CF","#FCA532")) +
  geom_pointrange(data=prs, aes(x=affirm_action, y=predicted,fill=group,
                                ymax=conf.high, ymin=conf.low), alpha=1,
             position=position_dodge(0.6), size=1, shape=21, col="black") +
  ylab("Audience (N)")  +
  xlab("Affirmative actions")+
  labs(tag="A")
  


my3 <- ggpredict(m3, terms=c("pc1","gender"))
my3 <- as.data.frame(my3)
my3$prof <- "Professors only"
f2 <- ggplot(my3, aes(x=x, y=predicted, col=group)) +
  geom_ribbon(aes(ymin=conf.low,ymax=conf.high, fill=group), alpha=0.3,
             colour = NA) +
    geom_line(size=1.5)+
  facet_grid(~prof)+
  scale_color_manual(name="Gender",values = c("#6D57CF","#FCA532"))+
  scale_fill_manual(name="Gender",values = c("#6D57CF","#FCA532"))+
   theme_cowplot() + ggtitle("") +
  ylab("Audience (N)") + xlab("Productivity index (PC1 axis)")+
  geom_point(data=dp, aes(x=pc1, y=audience_n, col=gender), alpha=0.6,
             size=2)+
  theme(legend.position="none") +
  labs(tag="C")


f3<- plot_spacer()

design <- "
           1111
           #22#
"

f1 + f2  + 
  plot_layout( design=design, guides="collect")
ggsave("figures/FIG_audience.jpeg", width=9, height = 8)  
```


```{r}

p1<- fviz_pca_biplot(pca1, col.ind = dp$gender, addEllipses=TRUE,
                      col.ind.sub="none",  geom="point",
                      repel = TRUE) +
  facet_grid(.~.)+
  geom_vline(xintercept = 0, linetype="dashed") + 
  geom_hline(yintercept = 0, linetype="dashed")+
  scale_color_manual(name="gender",values = c("#6D57CF","#FCA532"))+
  scale_shape(name="gender")+
  scale_fill_manual(name="gender",values = c("#6D57CF","#FCA532"))+
  labs(title="PCA professors' productivity", tag="B") +
  xlab("PC1 (52%)") + ylab("PC2 (21%)") +
  theme_cowplot() +
  theme(legend.position="none",
        plot.title = element_text(size=12, vjust=-5, hjust=0)) #+
  #coord_cartesian(clip = "off")+
  # scale_x_continuous(limits=c(-6,8), expand=c(0,0))+
  # scale_y_continuous(limits=c(-4,8), breaks=c(-4,-2,0,2,4,6))
  # annotate("rect", xmin=-6, xmax=8, ymin=7,ymax=8, fill="gray85")+
  #annotate("text",label="Professors'productivity", x=0, y=7.5, fill="gray85")



f1/(p1+f2) +plot_layout(guides="collect")
ggsave("figures/FIG_audience_test.jpeg", width=9, height = 8)  
```











